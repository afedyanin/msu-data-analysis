# Анализ данных на Python

- [Анализ данных на Python](https://eclass.cmc.msu.ru/course/view.php?id=250)

## Задание 2: Подсчет велосипедов

### 1. Введение
В этом задании мы будем использовать общедоступные данные о подсчете велосипедов в городе Гент (Бельгия). В Coupure Links, рядом с Факультетом инженерии биологических наук, счетчик отслеживает количество проезжающих велосипедистов в обоих направлениях.

```python
import pandas as pd
import matplotlib.pyplot as plt
plt.style.use('seaborn-whitegrid')
```

### 2. Чтение и обработка данных

#### Чтение CSV-данных

Данные.

Этот набор данных содержит исторические данные счетчиков велосипедов и состоит из следующих столбцов:

Дата в первом столбце — это дата в формате дд/мм/гг .

Второй столбец tijd — это время суток в формате чч:мм.

Третий и четвертый столбцы ri Centrum и ri Mariakerke — это счетчики на тот момент времени (счетчики между этой отметкой времени и предыдущей).

#### Обработка данных

Как объяснялось выше, первый и второй столбцы (соответственно datum и tijd ) указывают дату и час дня. Чтобы получить временной ряд, мы должны объединить эти два столбца в один ряд фактических значений временных меток.

#### УПРАЖНЕНИЕ 2

Предварительно обработайте данные:

- Объедините столбцы «datum» и «tijd» в одну серию Pandas строковых значений даты и времени, назовите эту новую переменную совмещенной .
- Разберите строковые значения даты и времени на объекты даты и времени.
- Установите результирующий столбец даты и времени в качестве индекса df DataFrame.
- Удалите исходные столбцы «datum» и «tijd», используя метод drop , и вызовите новый кадр данных df2 .
- Переименуйте столбцы в DataFrame «ri Centrum», «ri Mariakerke» соответственно. 'direction_centre', 'direction_mariakerke' с использованием метода переименования .
- Наличие данных, доступных с интерпретируемым datetime , дает нам возможность иметь график с учетом времени:

```python
fig, ax = plt.subplots(figsize=(10, 6))
df.plot(colormap='coolwarm', ax=ax)
```

Когда мы просто хотим интерпретировать даты, не указывая, как даты отформатированы, Pandas пытается сделать это как можно лучше:

```python
combined = df['datum'] + ' ' + df['tijd']
%timeit -n 1 -r 1 pd.to_datetime(combined, dayfirst=True)
```

Однако, когда мы уже знаем формат дат (и если он соответствует всему набору данных), мы можем использовать эту информацию для интерпретации дат:

```python
%timeit pd.to_datetime(combined, format="%d/%m/%Y %H:%M")
```

### Запишите очистку набора данных как функцию
Чтобы упростить повторное использование кода для предварительной обработки, которую мы реализовали, давайте преобразуем код в функцию Python:

#### УПРАЖНЕНИЕ 3

Напишите функцию process_bike_count_data(df) , которая выполняет этапы обработки, как описано выше, для входного кадра данных Pandas и возвращает обновленный кадр данных.

```python
df_raw = pd.read_csv("data/fietstellingencoupure.csv", sep=';')
df_preprocessed = process_bike_count_data(df_raw)
df_preprocessed.head()
```

#### Храните наш собранный набор данных в качестве промежуточного продукта данных

Когда мы завершили этап сбора данных, мы хотим сохранить этот результат в качестве промежуточного вывода данных нашего небольшого исследования. 
Таким образом, нам не нужно повторно загружать все файлы каждый раз, когда что-то пойдет не так, но мы можем начать заново с нашего промежуточного шага.

```python
df_preprocessed.to_csv("bike_count_interim.csv")
```

### 3. Исследование и анализ данных

Теперь у нас есть очищенный набор данных о подсчете велосипедов в Coupure Links в Генте (Бельгия). Далее мы хотим получить представление о характеристиках и свойствах данных.

Загрузите промежуточные данные

Чтение файла из промежуточного файла (если вы хотите повторить весь анализ обновленных онлайн-данных, вы должны закомментировать эту ячейку...)

```python
df = pd.read_csv("bike_count_interim.csv", index_col=0, parse_dates=True)
```
 
Проверка интервала подсчета
Количество байкеров подсчитывается с интервалом примерно в 15 минут. Но давайте проверим, так ли это на самом деле. 
Вычислите разницу между каждым из последовательных значений индекса. Мы можем использовать метод Series.diff() :

pd.Series(df.index).diff()

Представляет интерес количество возможных интервалов:

pd.Series(df.index).diff().value_counts()

Есть несколько записей, которые не ровно 15 минут. Но, учитывая, что их всего несколько, мы проигнорируем их для текущего тематического исследования и просто сохраним их для этого исследовательского исследования.

df.describe()

#### УПРАЖНЕНИЕ 4

Создайте новый ряд Pandas df_both , который содержит сумму значений обоих направлений.

#### УПРАЖНЕНИЕ 5

Используя df_both из предыдущего упражнения, создайте новую серию df_quiet , содержащую только те интервалы, за которые в сумме в обоих направлениях проехало менее 5 велосипедистов .

#### УПРАЖНЕНИЕ 6

По исходным данным df выбрать только те интервалы, за которые в том или ином направлении проехало менее 3 велосипедистов. Следовательно, менее 3 велосипедистов в сторону центра или менее 3 велосипедистов в сторону Мариакерке.

### Считать статистику

#### УПРАЖНЕНИЕ 7

Какое среднее количество велосипедистов проезжает каждые 15 минут?

#### УПРАЖНЕНИЕ 8

Какое среднее количество велосипедистов проезжает каждый час?

#### УПРАЖНЕНИЕ 9

Каковы 10 самых высоких пиковых значений, наблюдаемых в течение любого из интервалов для направления к центру Гента?

#### УПРАЖНЕНИЕ 10

Какое максимальное количество велосипедистов проехало за один день в обоих направлениях вместе взятых?

Большое количество байкеров, проехавших 05.06.2013, не случайно: http://www.nieuwsblad.be/cnt/dmf20130605_022 ;-)

#### УПРАЖНЕНИЕ 11

Как выглядит долгосрочный тренд? Рассчитайте ежемесячные суммы и постройте график результата.

#### УПРАЖНЕНИЕ 12

Давайте посмотрим на некоторые краткосрочные модели. Для данных за первые 3 недели января 2014 г. рассчитайте почасовые подсчеты и визуализируйте их.

### Новый год 2013-2014

#### УПРАЖНЕНИЕ 13

Выберите подмножество набора данных с 2013-12-31 12:00:00 до 2014-01-01 12:00:00 и назначьте результат новой переменной newyear.

Постройте выбранные данные newyear .

Используйте скользящую функцию с окном из 10 значений (см. документацию по функции), чтобы сгладить данные за этот период и построить график сглаженной версии.

Более продвинутое использование Matplotlib для создания комбинированного графика:

### Сила groupby ...

Глядя на данные в приведенных выше упражнениях, ясно видно:

- ежедневный шаблон
- еженедельный шаблон
- годовой шаблон

Такие шаблоны можно легко рассчитать и визуализировать в pandas, используя атрибуты DatetimeIndex dayofweek в сочетании с функциональностью groupby . Ниже вкус возможностей, а об этом мы узнаем в следующих блокнотах:

Недельный шаблон :

```python
df_daily = df.resample( 'D' ). сумма ()
df_daily.groupby(df_daily.index.dayofweek).mean().plot(kind = 'bar' )
```

Ежедневный шаблон:

```python
df_hourly.groupby(df_hourly.index.hour).mean().plot()
```

Таким образом, дневная картина явно отличается для обоих направлений. Утром больше людей идут на север, вечером больше людей идут на юг. Утренний пик также более сжат.

Ежемесячный шаблон

```python
df_monthly = df.resample('M').sum()
from calendar import month_abbr
ax = df_monthly.groupby(df_monthly.index.month).mean().plot()
ax.set_ylim(0)
xlabels = ax.set_xticklabels(list(month_abbr)[0::2])
```


